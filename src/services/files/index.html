<p>Drag files and/or directories to the box below!</p>
<div id="dropzone"><div id="boxtitle">Drop Files Here</div></div>

<h2>Directory tree:</h2>

<ul id="filelist"></ul>

<script>
  const dropzone = document.getElementById("dropzone");
  const filelist = document.getElementById("filelist");

  dropzone.addEventListener("dragover", (event) => {
    event.preventDefault();
    dropzone.classList.add("dragover");
  }, false);

  dropzone.addEventListener("dragleave", (event) => {
    event.preventDefault();
    dropzone.classList.remove("dragover");
  }, false);

  function traverseFiles(item) {
    if (item.isFile) {
      // read file
      item.file(file => {
        uploadFile(file, item.fullPath);
      });
    } else if (item.isDirectory) {
      let directoryReader = item.createReader();
      directoryReader.readEntries(function(entries) {
        entries.forEach(function(entry) {
          traverseFiles(entry);
        });
      });
    }
  }

  async function uploadFile(file, path) {
    let url = `http://localhost:4040/files/upload?path=${path}`;
    let formData = new FormData();
    formData.append("file", file);

    xhr = new XMLHttpRequest();

		// Update progress bar
		xhr.upload.addEventListener("progress", function (evt) {
			if (evt.lengthComputable) {
        console.log("progress:", (evt.loaded / evt.total) * 100 + "%");
				//progressBar.style.width = (evt.loaded / evt.total) * 100 + "%";
			}
			else {
				// No data to calculate on
			}
		}, false);

		// File uploaded
		xhr.addEventListener("load", function () {
      console.log("Uploaded!")
		}, false);

		xhr.open("post", url, true);
		// Set appropriate headers
		xhr.setRequestHeader("X-File-Name", file.name);
		xhr.setRequestHeader("X-File-Size", file.size);
		xhr.setRequestHeader("X-File-Type", file.type);

		// Send the file (doh)
    xhr.send(formData);
  }

  dropzone.addEventListener("drop", event => {
    event.preventDefault();
    dropzone.classList.remove("dragover");
    let items = event.dataTransfer.items;
    for (i = 0; i < items.length; i++) {
      let item = items[i].webkitGetAsEntry();
      if (item) {
        traverseFiles(item);
      }
    }
  }, false);
</script>

<style>
  #dropzone {
    text-align: center;
    width: 300px;
    height: 100px;
    margin: 10px;
    padding: 10px;
    border: 4px dashed red;
    border-radius: 10px;
  }

  #boxtitle {
    display: table-cell;
    vertical-align: middle;
    text-align: center;
    color: black;
    font: bold 2em "Arial", sans-serif;
    width: 300px;
    height: 100px;
  }

  body {
    font: 14px "Arial", sans-serif;
  }
</style>
